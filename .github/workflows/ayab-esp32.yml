name: Assembly Documentation (AYAB-ESP32)

on:
  push:
    paths:
      - 'ayab-esp32/**'

  pull_request:
    paths:
       - 'ayab-esp32/**'

jobs:
  buildfiles:
    name: Documentation Generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create output directory
        run: mkdir -p ayab-esp32/outputs/gerbers

      - name: Install KiCad
        run: sudo bash ./scripts/dependencies.sh

      - name: Export schematic PDF 
        run: kicad-cli sch export pdf -b -o ayab-esp32/outputs/ayab-esp32.pdf ayab-esp32/ayab-esp32.kicad_sch

      - name: Export BOM
        run: kicad-cli sch export bom -o ayab-esp32/outputs/ayab-esp32-BOM.csv --fields "Reference,Value,Footprint,JLCPCB PN" --exclude-dnp ayab-esp32/ayab-esp32.kicad_sch

      - name: Export CPL
        run: kicad-cli pcb export pos -o ayab-esp32/outputs/ayab-esp32-CPL.csv --side front --format ascii --use-drill-file-origin --exclude-dnp ayab-esp32/ayab-esp32.kicad_pcb

      - name: Export gerbers
        run: kicad-cli pcb export gerbers -o ayab-esp32/outputs/gerbers -l "F.Cu, F.Mask, F.Silkscreen, F.Paste, In1.Cu, In2.Cu, B.Cu, B.Mask, B.Silkscreen, B.Paste, Edge.Cuts"--erd --ev --use-drill-file-origin ayab-esp32/ayab-esp32.kicad_pcb

      - name: Export drills
        run: kicad-cli pcb export drill -o ayab-esp32/outputs/gerbers/ --drill-origin plot --generate-map --map-format gerberx2 ayab-esp32/ayab-esp32.kicad_pcb

      - name: Zip gerbers
        run: cd ayab-esp32/outputs; zip -r ayab-esp32-gerbers.zip gerbers; sudo rm -r gerbers

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ayab-esp32-artifacts
          path: ayab-esp32/outputs
